<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lampad | Music Finance Index</title>
  <meta name="description"
    content="Ranked view of music catalog assets across the market with integrated asset pricing engine and Monte Carlo simulations.">
  <!-- Inline Favicon (Music Note) -->
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: #020617;
      /* Deep slate dark background */
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      color: #e5e7eb;
    }

    /* Ensure the app container looks good as a standalone page */
    #lampad-index-app {
      padding: 40px 20px;
    }

    @media (max-width: 640px) {
      #lampad-index-app {
        padding: 10px 5px;
      }
    }
  </style>
</head>

<body>

  <!--
===========================================
LAMPAD MUSIC FINANCE INDEX â€“ EMBED SNIPPET (V5)
Artist/Country/Genre filters + NPV range + Mult range + sortable headers
NPV arrows: 50k step under 1m, 1m step at/above 1m
===========================================
-->




  <style>
    /* Root container */
    #lampad-index-app {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: transparent;
      color: #e5e7eb;
    }




    #lampad-index-app * {
      box-sizing: border-box;
    }




    /* Main card */
    #lampad-index-app .li-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(10px);
    }




    /* Header */
    #lampad-index-app h3 {
      margin: 0;
      font-size: 0.9rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #38bdf8;
    }




    #lampad-index-app h1 {
      font-size: 1.7rem;
      margin: 4px 0 6px;
      color: #f9fafb;
      line-height: 1.25;
    }




    #lampad-index-app .li-subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 18px;
    }




    #lampad-index-app .li-status {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }




    #lampad-index-app .li-status span {
      color: #38bdf8;
    }




    /* Controls row */
    #lampad-index-app .li-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 14px;
    }




    #lampad-index-app .li-field {
      flex: 1 1 220px;
      min-width: 0;
    }




    /* NPV & Mult rows â€“ full width, appear below text filters */
    #lampad-index-app .li-field-npv,
    #lampad-index-app .li-field-mult {
      flex: 1 1 100%;
      min-width: 0;
      margin-top: 4px;
    }




    #lampad-index-app label {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
      color: #9ca3af;
    }




    #lampad-index-app input[type="text"],
    #lampad-index-app input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 0.9rem;
    }




    #lampad-index-app input[type="text"]::placeholder,
    #lampad-index-app input[type="number"]::placeholder {
      color: #6b7280;
    }




    #lampad-index-app input[type="text"]:focus,
    #lampad-index-app input[type="number"]:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }




    /* Range layouts */
    #lampad-index-app .li-npv-range,
    #lampad-index-app .li-mult-range,
    #lampad-index-app .li-sigma-range {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 6px;
      align-items: center;
    }

    #lampad-index-app .li-npv-range span,
    #lampad-index-app .li-mult-range span,
    #lampad-index-app .li-sigma-range span {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
    }

    #lampad-index-app .li-npv-hint,
    #lampad-index-app .li-mult-hint,
    #lampad-index-app .li-sigma-hint {
      margin-top: 2px;
      font-size: 0.7rem;
      color: #6b7280;
    }




    /* Pill: summary of sort/limit */
    #lampad-index-app .li-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #9ca3af;
      gap: 6px;
      white-space: nowrap;
    }




    #lampad-index-app .li-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }




    /* ===================== */
    /* DESKTOP TABLE VIEW    */
    /* ===================== */




    #lampad-index-app .li-table-wrap {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      max-height: 520px;
      overflow: auto;
    }




    #lampad-index-app table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }




    #lampad-index-app th,
    #lampad-index-app td {
      padding: 6px 8px;
      text-align: right;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }




    #lampad-index-app th {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 1);
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.7rem;
      z-index: 1;
    }




    /* Sortable headers */
    #lampad-index-app th.li-sortable {
      cursor: pointer;
      user-select: none;
    }




    #lampad-index-app .li-sort-indicator {
      margin-left: 4px;
      font-size: 0.6rem;
      opacity: 0.6;
    }




    #lampad-index-app th.li-col-artist,
    #lampad-index-app td.li-col-artist {
      text-align: left;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }




    #lampad-index-app th.li-col-country,
    #lampad-index-app td.li-col-country {
      text-align: left;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }




    #lampad-index-app th.li-col-genre,
    #lampad-index-app td.li-col-genre {
      text-align: left;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }




    #lampad-index-app tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }




    #lampad-index-app tbody tr:hover {
      background: rgba(56, 189, 248, 0.08);
    }




    /* ===================== */
    /* MOBILE CARD VIEW      */
    /* ===================== */




    #lampad-index-app .li-card-list {
      display: none;
      /* hidden on desktop, shown on mobile via media query */
      margin-top: 10px;
      max-height: 520px;
      overflow: auto;
    }




    #lampad-index-app .li-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(55, 65, 81, 0.9);
      margin-bottom: 8px;
    }




    #lampad-index-app .li-card-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }




    #lampad-index-app .li-rank {
      font-size: 0.75rem;
      color: #a5b4fc;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.6);
      background: rgba(15, 23, 42, 0.9);
    }




    #lampad-index-app .li-card-artist {
      font-size: 0.95rem;
      font-weight: 600;
      color: #f9fafb;
    }




    #lampad-index-app .li-card-meta {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 2px;
    }




    #lampad-index-app .li-card-metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }




    #lampad-index-app .li-metric {
      font-size: 0.75rem;
    }




    #lampad-index-app .li-metric-label {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 1px;
    }




    #lampad-index-app .li-metric-value {
      color: #e5e7eb;
    }




    /* RESPONSIVE BEHAVIOR */




    /* On small screens: hide table, show cards */
    @media (max-width: 800px) {
      #lampad-index-app .li-table-wrap {
        display: none;
      }


      #lampad-index-app .li-card-list {
        display: block;
      }
    }




    /* On very small screens, collapse metric grid to 2 columns */
    @media (max-width: 480px) {
      #lampad-index-app .li-card-metrics {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }


    /* MODAL OVERLAY STYLES */
    #lampad-valuation-overlay,
    #lampad-market-stats-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 10000;
      overflow-y: auto;
      padding: 20px 15px;
      box-sizing: border-box;
    }


    #lampad-valuation-overlay *,
    #lampad-valuation-overlay *::before,
    #lampad-valuation-overlay *::after,
    #lampad-market-stats-overlay *,
    #lampad-market-stats-overlay *::before,
    #lampad-market-stats-overlay *::after {
      box-sizing: border-box;
    }


    #lampad-valuation-overlay.active,
    #lampad-market-stats-overlay.active {
      display: block;
    }


    #lampad-valuation-overlay .modal-content,
    #lampad-market-stats-overlay .modal-content {
      position: relative;
      max-width: 1100px;
      margin: 0 auto;
      background: #0f172a;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }


    #lampad-valuation-overlay .close-btn,
    #lampad-market-stats-overlay .close-btn {
      position: fixed;
      top: 20px;
      right: 30px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      line-height: 1;
      z-index: 10001;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }


    #lampad-valuation-overlay .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }


    /* Adjust modal content padding for fixed button */
    @media (max-width: 640px) {
      #lampad-valuation-overlay {
        padding: 10px;
      }


      #lampad-valuation-overlay .close-btn {
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        font-size: 20px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
    }


    /* CSV Export Button Styles */
    #lampad-index-app .li-export-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.4);
      border-radius: 10px;
      color: #38bdf8;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
      margin-bottom: 4px;
    }


    #lampad-index-app .li-export-btn:hover {
      background: rgba(56, 189, 248, 0.2);
      border-color: #38bdf8;
      transform: translateY(-1px);
    }


    #lampad-index-app .li-export-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }


    /* INTEGRATED PRICING SIM STYLES */
    #pricing-sim-app {
      font-family: inherit;
      background: transparent;
      color: #e5e7eb;
      padding: 0;
      /* Container padding handled by modal-content */
    }


    #pricing-sim-app * {
      box-sizing: border-box;
    }


    #pricing-sim-app .ps-container {
      width: 100%;
      padding: 24px;
      background: transparent;
      border: none;
      backdrop-filter: none;
    }


    #pricing-sim-app header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
      padding-right: 44px;
      /* Space for close button */
    }


    #pricing-sim-app .ps-header-text {
      flex: 1 1 auto;
      min-width: 0;
    }





    #pricing-sim-app h3 {
      margin: 0;
      font-size: 0.8rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #38bdf8;
    }


    #pricing-sim-app h4 {
      font-size: 1.4rem;
      margin: 2px 0 4px;
      color: #f9fafb;
      line-height: 1.2;
    }


    #pricing-sim-app .ps-subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }


    #pricing-sim-app .ps-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 20px;
    }


    #pricing-sim-app .ps-field {
      flex: 1 1 200px;
      min-width: 0;
    }


    #pricing-sim-app label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
      color: #9ca3af;
    }


    #pricing-sim-app input[type="text"],
    #pricing-sim-app input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 0.9rem;
    }


    #pricing-sim-app .ps-search-wrapper {
      position: relative;
    }


    #pricing-sim-app .ps-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      max-height: 220px;
      overflow-y: auto;
      background: #020617;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      z-index: 9999;
      display: none;
    }


    #pricing-sim-app .ps-dropdown.ps-open {
      display: block;
    }


    #pricing-sim-app .ps-dropdown-item {
      padding: 7px 10px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }


    #pricing-sim-app .ps-dropdown-item:hover {
      background: rgba(56, 189, 248, 0.15);
    }


    .ps-summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }


    @media (max-width: 900px) {
      .ps-summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }


    @media (max-width: 640px) {
      .ps-summary-grid {
        grid-template-columns: 1fr;
      }
    }


    .ps-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(148, 163, 184, 0.35);
    }


    .ps-card-muted {
      background: rgba(15, 23, 42, 0.9);
    }


    .ps-card-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 4px;
    }


    .ps-card-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #f9fafb;
    }


    .ps-card-sub {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 2px;
    }


    #pricing-sim-app .ps-chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.7rem;
      background: rgba(15, 118, 110, 0.22);
      border: 1px solid rgba(45, 212, 191, 0.4);
      color: #a7f3d0;
    }


    #pricing-sim-app .ps-risk-expl {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.4;
    }


    #pricing-sim-app .ps-chart-wrap {
      margin-bottom: 20px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 12px;
      height: 300px;
      overflow: hidden;
    }


    #pricing-sim-app .ps-chart-title {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }


    #pricing-sim-app .ps-chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      font-size: 0.7rem;
      color: #e5e7eb;
      margin-bottom: 8px;
    }


    #pricing-sim-app .ps-legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }


    #pricing-sim-app .ps-legend-swatch {
      width: 18px;
      height: 3px;
      border-radius: 999px;
    }


    #pricing-sim-app .ps-legend-p5 .ps-legend-swatch {
      background: rgba(248, 113, 113, 1);
    }


    #pricing-sim-app .ps-legend-mean .ps-legend-swatch {
      background: rgba(56, 189, 248, 1);
    }


    #pricing-sim-app .ps-legend-p95 .ps-legend-swatch {
      background: rgba(96, 165, 250, 1);
    }


    #pricing-sim-app .ps-table-wrap {
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      overflow: auto;
      max-height: 300px;
    }


    #pricing-sim-app table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }


    #pricing-sim-app th,
    #pricing-sim-app td {
      padding: 6px 8px;
      text-align: right;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }


    #pricing-sim-app th {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 1);
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.65rem;
      z-index: 1;
    }


    #pricing-sim-app td:first-child,
    #pricing-sim-app th:first-child {
      text-align: left;
    }


    #pricing-sim-app tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }


    #pricing-sim-app .ps-status {
      font-size: 0.75rem;
      color: #9ca3af;
    }


    #pricing-sim-app .ps-status span {
      color: #38bdf8;
    }


    /* Make row clickable */
    #lampad-index-app tbody tr {
      cursor: pointer;
    }

    /* ===================== */
    /* AUTHENTICATION STYLES */
    /* ===================== */

    #auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s ease;
    }

    #auth-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .auth-container {
      max-width: 420px;
      width: 90%;
      padding: 40px 32px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .auth-title {
      font-size: 1.5rem;
      color: #f9fafb;
      margin: 0 0 8px 0;
      font-weight: 600;
    }

    .auth-subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin: 0;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .auth-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .auth-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      font-weight: 500;
    }

    .auth-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .auth-input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }

    .auth-button {
      padding: 14px 24px;
      background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 0.95rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .auth-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.3);
    }

    .auth-button:active {
      transform: translateY(0);
    }

    .auth-error {
      padding: 16px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #ef4444;
      border-radius: 12px;
      color: #ef4444;
      font-size: 0.9rem;
      text-align: center;
      display: none;
      font-family: 'Courier New', Courier, monospace;
      font-weight: bold;
    }

    .auth-error img {
      width: 100%;
      border-radius: 8px;
      margin-top: 8px;
      border: 1px solid #ef4444;
    }

    .auth-error.show {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-10px);
      }

      75% {
        transform: translateX(10px);
      }
    }

    .auth-footer {
      margin-top: 24px;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .auth-lock-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>


  <!-- AUTHENTICATION OVERLAY -->
  <div id="auth-overlay">
    <div class="auth-container">
      <div class="auth-header">
        <div class="auth-logo">ðŸ”’</div>
        <h2 class="auth-title">Lampad Access</h2>
        <p class="auth-subtitle">Secure authentication required</p>
      </div>

      <form id="auth-form" class="auth-form">
        <div class="auth-field">
          <label class="auth-label" for="auth-username">Username</label>
          <input type="text" id="auth-username" class="auth-input" placeholder="Enter username" autocomplete="username"
            required>
        </div>

        <div class="auth-field">
          <label class="auth-label" for="auth-password">Password</label>
          <input type="password" id="auth-password" class="auth-input" placeholder="Enter password"
            autocomplete="current-password" required>
        </div>

        <div id="auth-error" class="auth-error">
          <div>YOU DIDN'T SAY THE MAGIC WORD!</div>
          <img src="https://media1.tenor.com/m/Vyg73kR334sAAAAC/jurassic-park-ah.gif" alt="Ah ah ah!">
        </div>

        <button type="submit" class="auth-button">
          <span class="auth-lock-icon">ðŸ”“</span>
          Sign In
        </button>
      </form>

      <div class="auth-footer">
        <svg class="auth-lock-icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
            clip-rule="evenodd" />
        </svg>
        Protected by Lampad Security
      </div>
    </div>
  </div>

  <div id="lampad-index-app">
    <div class="li-container">
      <!-- HEADER -->
      <header>
        <h3>Lampad</h3>
        <h1>Music Finance Index</h1>
        <div class="li-subtitle">
          Ranked view of catalog assets across the market. Default view shows the top <strong>1000</strong> artists by
          risk-adjusted multiple.
        </div>
        <div class="li-status" id="li-status">Loading index dataâ€¦</div>
      </header>




      <!-- CONTROLS -->
      <section class="li-controls">
        <div class="li-field">
          <label for="li-artist-input">Filter by Artist</label>
          <input type="text" id="li-artist-input" placeholder="e.g. The Police, REM, Julio Iglesiasâ€¦"
            autocomplete="off">
        </div>




        <div class="li-field">
          <label for="li-country-input">Filter by Country</label>
          <input type="text" id="li-country-input" placeholder="e.g. United States, United Kingdom, Brazilâ€¦"
            autocomplete="off">
        </div>




        <div class="li-field">
          <label for="li-genre-input">Filter by Genre</label>
          <input type="text" id="li-genre-input" placeholder="e.g. Rock, Pop, Reggaetonâ€¦" autocomplete="off">
        </div>




        <div class="li-field li-field-npv">
          <label>NPV Range (USD)</label>
          <div class="li-npv-range">
            <input type="number" id="li-npv-min" placeholder="Min">
            <span>to</span>
            <input type="number" id="li-npv-max" placeholder="Max">
          </div>
          <div class="li-npv-hint">
            Optional. Leave blank for no bound. Uses raw NPV dollars (not k/m shorthand).
          </div>
        </div>




        <div class="li-field li-field-mult">
          <label>Mult Range</label>
          <div class="li-mult-range">
            <input type="number" id="li-mult-min" placeholder="Min" step="0.01" inputmode="decimal">
            <span>to</span>
            <input type="number" id="li-mult-max" placeholder="Max" step="0.01" inputmode="decimal">
          </div>
          <div class="li-mult-hint">
            Optional. Leave blank for no bound.
          </div>
        </div>


        <div class="li-field li-field-sigma">
          <label>Sigma Range (%)</label>
          <div class="li-sigma-range">
            <input type="number" id="li-sigma-min" placeholder="Min" step="0.1" inputmode="decimal">
            <span>to</span>
            <input type="number" id="li-sigma-max" placeholder="Max" step="0.1" inputmode="decimal">
          </div>
          <div class="li-sigma-hint">
            Optional. Range of 0-500%.
          </div>
        </div>




        <div>
          <div class="li-pill">
            <span class="li-pill-dot"></span>
            <span id="li-pill-text">Sorted by Mult (desc), showing top 1000</span>
          </div>
        </div>
      </section>




      <!-- EXPORT OPTIONS -->
      <div style="display: flex; justify-content: flex-end; gap: 8px; padding: 0 4px;">
        <button id="li-market-stats" class="li-export-btn">
          <svg viewBox="0 0 24 24">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
          </svg>
          Market Stats
        </button>
        <button id="li-export-csv" class="li-export-btn">
          <svg viewBox="0 0 24 24">
            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
          </svg>
          Export to CSV
        </button>
      </div>




      <!-- DESKTOP TABLE VIEW -->
      <section class="li-table-wrap">
        <table>
          <thead>
            <tr>
              <th class="li-col-artist li-sortable" data-sort-key="artist">
                Artist
                <span class="li-sort-indicator" data-sort-indicator="artist"></span>
              </th>
              <th class="li-col-country li-sortable" data-sort-key="country">
                Country
                <span class="li-sort-indicator" data-sort-indicator="country"></span>
              </th>
              <th class="li-col-genre li-sortable" data-sort-key="genre">
                Genre
                <span class="li-sort-indicator" data-sort-indicator="genre"></span>
              </th>
              <th class="li-sortable" data-sort-key="mu">
                Mu
                <span class="li-sort-indicator" data-sort-indicator="mu"></span>
              </th>
              <th class="li-sortable" data-sort-key="sigma">
                Sigma
                <span class="li-sort-indicator" data-sort-indicator="sigma"></span>
              </th>
              <th class="li-sortable" data-sort-key="muSigma">
                Mu / Sigma
                <span class="li-sort-indicator" data-sort-indicator="muSigma"></span>
              </th>
              <th class="li-sortable" data-sort-key="mult">
                Mult
                <span class="li-sort-indicator" data-sort-indicator="mult"></span>
              </th>
              <th class="li-sortable" data-sort-key="discountRate">
                Disc.<br>Rate
                <span class="li-sort-indicator" data-sort-indicator="discountRate"></span>
              </th>
              <th class="li-sortable" data-sort-key="npv">
                NPV
                <span class="li-sort-indicator" data-sort-indicator="npv"></span>
              </th>
            </tr>
          </thead>
          <tbody id="li-table-body"></tbody>
        </table>
      </section>




      <!-- MOBILE CARD VIEW -->
      <section class="li-card-list" id="li-card-list">
        <!-- Cards injected via JS -->
      </section>
    </div>
  </div>




  <!-- VALUATION OVERLAY -->
  <div id="lampad-valuation-overlay">
    <button class="close-btn" id="close-valuation">&times;</button>
    <div class="modal-content">


      <div id="pricing-sim-app">
        <div class="ps-container">
          <!-- HEADER -->
          <header>
            <div class="ps-header-text">
              <h3>Lampad</h3>
              <h4>Music Finance Index &<br>Asset Pricing Engine</h4>
              <div class="ps-subtitle">
                Monte Carlo simulation and valuation of artist cash flows using observed metrics and comparing vs market
                benchmarks.
              </div>
              <div class="ps-status" id="ps-status">Loading model dataâ€¦</div>
            </div>
          </header>


          <!-- CONTROLS -->
          <section class="ps-controls">
            <div class="ps-field">
              <label for="ps-artist-input">Artist</label>
              <div class="ps-search-wrapper">
                <input type="text" id="ps-artist-input" placeholder="Type to search artistâ€¦" autocomplete="off">
                <div id="ps-artist-dropdown" class="ps-dropdown"></div>
              </div>
            </div>


            <div class="ps-field">
              <label for="ps-discount-input">Discount rate (%)</label>
              <input type="number" id="ps-discount-input" min="0" max="50" step="0.1" value="10">
            </div>
          </section>


          <!-- SUMMARY GRID -->
          <section class="ps-summary">
            <div class="ps-summary-grid">
              <div class="ps-card">
                <div class="ps-card-label">Artist</div>
                <div class="ps-card-value" id="ps-artist-name">â€“</div>
                <div class="ps-card-sub" id="ps-artist-meta">Select an artist to run the simulation.</div>
              </div>


              <div class="ps-card ps-card-muted">
                <div class="ps-card-label">Mu / Sigma</div>
                <div class="ps-card-value" id="ps-mu-sigma">â€“</div>
                <div class="ps-card-sub" id="ps-mu-sigma-sub">â€“</div>
              </div>


              <div class="ps-card ps-card-muted">
                <div class="ps-card-label">Base NPV & CFâ‚€</div>
                <div class="ps-card-value" id="ps-npv-cf0">â€“</div>
                <div class="ps-card-sub" id="ps-npv-cf0-sub">â€“</div>
              </div>


              <div class="ps-card ps-card-muted">
                <div class="ps-card-label">Simulated NPV (User Rate)</div>
                <div class="ps-card-value" id="ps-npv-user">â€“</div>
                <div class="ps-card-sub" id="ps-npv-user-sub">P5 / Mean / P95</div>
              </div>


              <div class="ps-card ps-card-muted">
                <div class="ps-card-label">Discount Rates</div>
                <div class="ps-card-value" id="ps-implied-rates">â€“</div>
                <div class="ps-card-sub" id="ps-implied-rates-sub">Market vs Implied</div>
              </div>


              <div class="ps-card ps-card-muted">
                <div class="ps-card-label">Market Rating</div>
                <div class="ps-card-value">
                  <span class="ps-chip" id="ps-risk-score">â€“</span>
                  <span id="ps-heroic-badge"
                    style="display:none; margin-left:8px; padding:4px 8px; background:linear-gradient(135deg, #f59e0b, #d97706); color:white; border-radius:6px; font-size:0.65rem; text-transform:uppercase; font-weight:bold; letter-spacing:0.05em; vertical-align:middle; box-shadow:0 0 10px rgba(245, 158, 11, 0.4);">Heroic
                    Trajectory</span>
                </div>
                <div class="ps-risk-expl" id="ps-risk-expl">â€“</div>
              </div>
            </div>
          </section>


          <!-- MAIN CHART -->
          <section class="ps-chart-wrap">
            <div class="ps-chart-title">Simulated Monthly Cash Flow</div>
            <div class="ps-chart-legend">
              <span class="ps-legend-item ps-legend-p5">
                <span class="ps-legend-swatch"></span>
                <span>P5 CF</span>
              </span>
              <span class="ps-legend-item ps-legend-mean">
                <span class="ps-legend-swatch"></span>
                <span>Mean CF</span>
              </span>
              <span class="ps-legend-item ps-legend-p95">
                <span class="ps-legend-swatch"></span>
                <span>P95 CF</span>
              </span>
            </div>
            <canvas id="ps-cf-chart"></canvas>
          </section>


          <!-- ANNUAL TABLE -->
          <section>
            <div class="ps-chart-title">Annual CF Forecast</div>
            <div class="ps-table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>P5 CF</th>
                    <th>Mean CF</th>
                    <th>P95 CF</th>
                  </tr>
                </thead>
                <tbody id="ps-month-table-body"></tbody>
              </table>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>


  <!-- MARKET STATS OVERLAY -->
  <div id="lampad-market-stats-overlay">
    <button class="close-btn" id="close-market-stats">&times;</button>
    <div class="modal-content">
      <div id="market-stats-app" style="padding: 24px;">
        <header style="margin-bottom: 24px;">
          <h3 style="margin: 0; font-size: 0.8rem; letter-spacing: 0.16em; text-transform: uppercase; color: #38bdf8;">
            Lampad</h3>
          <h4 style="font-size: 1.4rem; margin: 2px 0 4px; color: #f9fafb;">Market Statistics</h4>
          <div style="font-size: 0.85rem; color: #9ca3af;">Global aggregate metrics and distribution analysis for
            the current index.</div>
        </header>

        <div id="market-stats-content">
          <div class="ps-summary-grid" style="margin-bottom: 24px;">
            <div class="ps-card">
              <div class="ps-card-label">Mean Sigma</div>
              <div class="ps-card-value" id="stats-mean-sigma">â€“</div>
              <div class="ps-card-sub">Winsorized Avg</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Median Sigma</div>
              <div class="ps-card-value" id="stats-median-sigma">â€“</div>
              <div class="ps-card-sub">50th Percentile</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Std Deviation</div>
              <div class="ps-card-value" id="stats-std-sigma">â€“</div>
              <div class="ps-card-sub">Volatility Spread</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Median Mult</div>
              <div class="ps-card-value" id="stats-median-mult">â€“</div>
              <div class="ps-card-sub">Market Pricing</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Mean Disc. Rate</div>
              <div class="ps-card-value" id="stats-mean-discount">â€“</div>
              <div class="ps-card-sub">Avg Required Return</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Median Disc. Rate</div>
              <div class="ps-card-value" id="stats-median-discount">â€“</div>
              <div class="ps-card-sub">50th Percentile</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Mean Mu/Sigma</div>
              <div class="ps-card-value" id="stats-mean-musigma">â€“</div>
              <div class="ps-card-sub">Reward-to-Risk</div>
            </div>
            <div class="ps-card">
              <div class="ps-card-label">Heroic Artists</div>
              <div class="ps-card-value" id="stats-heroic-count">â€“</div>
              <div class="ps-card-sub">High Mu / Low Sigma</div>
            </div>
          </div>

          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <section class="ps-chart-wrap" style="height: 380px; margin-bottom: 0;">
              <div class="ps-chart-title">Sigma Distribution</div>
              <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 8px;">
                Histogram of market volatility profiles (Winsorized at 97.5th pctl).
              </div>
              <div style="flex: 1; position: relative; height: 280px;">
                <canvas id="market-sigma-chart"></canvas>
              </div>
            </section>

            <section class="ps-chart-wrap" style="height: 380px; margin-bottom: 0;">
              <div class="ps-chart-title">Risk-Reward Frontier</div>
              <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 8px;">
                Multiple vs. Sigma. Scatter plot visualizing the trade-off between price and risk.
              </div>
              <div style="flex: 1; position: relative; height: 280px;">
                <canvas id="market-scatter-chart"></canvas>
              </div>
            </section>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px;">
            <section class="ps-chart-wrap" style="height: 380px; margin-bottom: 0;">
              <div class="ps-chart-title">Discount Rate Distribution</div>
              <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 8px;">
                Market-implied required returns (Winsorized at 97.5th pctl). Shows realistic discount rate expectations.
              </div>
              <div style="flex: 1; position: relative; height: 280px;">
                <canvas id="market-discount-chart"></canvas>
              </div>
            </section>

            <section class="ps-chart-wrap" style="height: 380px; margin-bottom: 0;">
              <div class="ps-chart-title">Risk-Return Relationship</div>
              <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 8px;">
                Discount Rate vs. Sigma (Winsorized at 97.5th pctl). How required returns scale with volatility.
              </div>
              <div style="flex: 1; position: relative; height: 280px;">
                <canvas id="market-discount-scatter-chart"></canvas>
              </div>
            </section>
          </div>

          <div id="market-stats-interpretation"
            style="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; border: 1px solid rgba(55, 65, 81, 0.5);">
            <h5
              style="margin: 0 0 8px 0; font-size: 0.75rem; text-transform: uppercase; color: #38bdf8; letter-spacing: 0.05em;">
              Statistical Interpretation</h5>
            <div id="stats-interpretation-text" style="font-size: 0.8rem; color: #9ca3af; line-height: 1.5;">
              Calculating distribution profile...
            </div>
          </div>

          <!-- TAM SECTION -->
          <div
            style="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; border: 1px solid rgba(55, 65, 81, 0.5);">
            <h5
              style="margin: 0 0 12px 0; font-size: 0.75rem; text-transform: uppercase; color: #38bdf8; letter-spacing: 0.05em;">
              Total Addressable Market (TAM)
            </h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <div
                style="padding: 10px; background: rgba(15, 23, 42, 0.8); border-radius: 8px; border: 1px solid rgba(55, 65, 81, 0.3);">
                <div
                  style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">
                  Total Market Cap</div>
                <div style="font-size: 1.1rem; font-weight: 600; color: #f9fafb;" id="tam-market-cap">â€“</div>
                <div style="font-size: 0.65rem; color: #6b7280; margin-top: 2px;">Sum of all NPVs</div>
              </div>
              <div
                style="padding: 10px; background: rgba(15, 23, 42, 0.8); border-radius: 8px; border: 1px solid rgba(55, 65, 81, 0.3);">
                <div
                  style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">
                  Annual Revenue</div>
                <div style="font-size: 1.1rem; font-weight: 600; color: #f9fafb;" id="tam-annual-rev">â€“</div>
                <div style="font-size: 0.65rem; color: #6b7280; margin-top: 2px;">Î£(NPV / Multiple)</div>
              </div>
              <div
                style="padding: 10px; background: rgba(15, 23, 42, 0.8); border-radius: 8px; border: 1px solid rgba(55, 65, 81, 0.3);">
                <div
                  style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">
                  Weighted Avg Mult</div>
                <div style="font-size: 1.1rem; font-weight: 600; color: #f9fafb;" id="tam-avg-mult">â€“</div>
                <div style="font-size: 0.65rem; color: #6b7280; margin-top: 2px;">Market Cap / Revenue</div>
              </div>
              <div
                style="padding: 10px; background: rgba(15, 23, 42, 0.8); border-radius: 8px; border: 1px solid rgba(55, 65, 81, 0.3);">
                <div
                  style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">
                  Top 10% Share</div>
                <div style="font-size: 1.1rem; font-weight: 600; color: #f9fafb;" id="tam-concentration">â€“</div>
                <div style="font-size: 0.65rem; color: #6b7280; margin-top: 2px;">Market concentration</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>




    <script>
      (function () {
        /* ========================================= */
        /* AUTHENTICATION SYSTEM - FORT KNOX MODE   */
        /* ========================================= */

        const AUTH_CONFIG = {
          SESSION_KEY: 'lampad_auth_session',
          ACTIVITY_KEY: 'lampad_last_activity',
          SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutes in milliseconds

          // IMPORTANT: Change these credentials before deploying!
          // These are hashed using SHA-256. To generate new hashes:
          // 1. Open browser console
          // 2. Run: await crypto.subtle.digest('SHA-256', new TextEncoder().encode('your_password'))
          // 3. Run: Array.from(new Uint8Array(result)).map(b => b.toString(16).padStart(2, '0')).join('')

          USERS: {
            'admin': '2d603c248d96b22dd312206b61c5d08999f8e83d9c99a2dff107c4fe448b82a3', // Default: "lampad2024"
            // Add more users here as needed:
            // 'username': 'hashed_password_here',
          }
        };

        let isAuthenticated = false;
        let activityTimer = null;

        // SHA-256 hashing function
        async function hashPassword(password) {
          const msgBuffer = new TextEncoder().encode(password);
          const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if session is valid
        function checkSession() {
          const session = localStorage.getItem(AUTH_CONFIG.SESSION_KEY);
          const lastActivity = localStorage.getItem(AUTH_CONFIG.ACTIVITY_KEY);

          if (!session || !lastActivity) {
            return false;
          }

          const now = Date.now();
          const timeSinceActivity = now - parseInt(lastActivity, 10);

          // Session expired due to inactivity
          if (timeSinceActivity > AUTH_CONFIG.SESSION_TIMEOUT) {
            logout();
            return false;
          }

          return session === 'authenticated';
        }

        // Update last activity timestamp
        function updateActivity() {
          localStorage.setItem(AUTH_CONFIG.ACTIVITY_KEY, Date.now().toString());
        }

        // Set up activity tracking
        function setupActivityTracking() {
          // Track mouse movement, clicks, and keyboard activity
          ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
          });

          // Check session validity every minute
          activityTimer = setInterval(() => {
            if (!checkSession()) {
              showAuthOverlay();
              alert('Your session has expired due to inactivity. Please log in again.');
            }
          }, 60000); // Check every minute
        }

        // Authenticate user
        async function authenticate(username, password) {
          const hashedPassword = await hashPassword(password);

          if (AUTH_CONFIG.USERS[username] && AUTH_CONFIG.USERS[username] === hashedPassword) {
            localStorage.setItem(AUTH_CONFIG.SESSION_KEY, 'authenticated');
            localStorage.setItem(AUTH_CONFIG.ACTIVITY_KEY, Date.now().toString());
            isAuthenticated = true;
            return true;
          }

          return false;
        }

        // Logout
        function logout() {
          localStorage.removeItem(AUTH_CONFIG.SESSION_KEY);
          localStorage.removeItem(AUTH_CONFIG.ACTIVITY_KEY);
          isAuthenticated = false;
          if (activityTimer) {
            clearInterval(activityTimer);
          }
        }

        // Show/hide auth overlay
        function showAuthOverlay() {
          document.getElementById('auth-overlay').classList.remove('hidden');
        }

        function hideAuthOverlay() {
          document.getElementById('auth-overlay').classList.add('hidden');
        }

        // Handle login form submission
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
          e.preventDefault();

          const username = document.getElementById('auth-username').value.trim();
          const password = document.getElementById('auth-password').value;
          const errorEl = document.getElementById('auth-error');

          // Clear previous errors
          errorEl.classList.remove('show');

          // Attempt authentication
          const success = await authenticate(username, password);

          if (success) {
            hideAuthOverlay();
            setupActivityTracking();

            // Initialize the application
            initializeApp();

            // Clear form
            document.getElementById('auth-form').reset();
          } else {
            // Show error
            errorEl.classList.add('show');

            // Clear password field
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-password').focus();

            // Hide error after 5 seconds
            setTimeout(() => {
              errorEl.classList.remove('show');
            }, 5000);
          }
        });

        // Check session on page load
        if (checkSession()) {
          isAuthenticated = true;
          hideAuthOverlay();
          setupActivityTracking();
          // App will initialize normally below
        } else {
          showAuthOverlay();
          // Prevent app initialization until authenticated
          return;
        }

        /* ========================================= */
        /* END AUTHENTICATION SYSTEM                */
        /* ========================================= */

        // Wrap the entire app initialization in a function
        function initializeApp() {
          if (!isAuthenticated) return;

          const CSV_URL =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vQn3QMkLXrOtH76c4ZtlUBfXDYLhIELYr_yehZoZ8OtsRdMGPYU5bIw5f7B358Z99jQIpWIdMI05tdM/pub?gid=2141684423&single=true&output=csv";




          const MAX_DEFAULT_ROWS = 1000;




          const statusEl = document.getElementById("li-status");
          const pillTextEl = document.getElementById("li-pill-text");
          const tableBodyEl = document.getElementById("li-table-body");
          const cardListEl = document.getElementById("li-card-list");




          const artistInput = document.getElementById("li-artist-input");
          const countryInput = document.getElementById("li-country-input");
          const genreInput = document.getElementById("li-genre-input");
          const npvMinInput = document.getElementById("li-npv-min");
          const npvMaxInput = document.getElementById("li-npv-max");
          const multMinInput = document.getElementById("li-mult-min");
          const multMaxInput = document.getElementById("li-mult-max");
          const sigmaMinInput = document.getElementById("li-sigma-min");
          const sigmaMaxInput = document.getElementById("li-sigma-max");

          /* Market Stats Elements */
          const statsOverlay = document.getElementById("lampad-market-stats-overlay");
          const openStatsBtn = document.getElementById("li-market-stats");
          const closeStatsBtn = document.getElementById("close-market-stats");




          const headerCells = document.querySelectorAll(
            '#lampad-index-app th[data-sort-key]'
          );
          const sortIndicators = document.querySelectorAll(
            '#lampad-index-app .li-sort-indicator'
          );

          let marketBenchmarks = {};




          let allArtists = [];
          let currentView = [];




          let sortState = { key: "mult", dir: "desc" };




          /* ---------- CSV parsing ---------- */




          function parseCsv(text) {
            const rows = [];
            let row = [];
            let cur = "";
            let inQuotes = false;




            for (let i = 0; i < text.length; i++) {
              const ch = text[i];
              if (inQuotes) {
                if (ch === '"') {
                  if (text[i + 1] === '"') { cur += '"'; i++; }
                  else { inQuotes = false; }
                } else {
                  cur += ch;
                }
              } else {
                if (ch === '"') inQuotes = true;
                else if (ch === ",") { row.push(cur); cur = ""; }
                else if (ch === "\r") { /* ignore */ }
                else if (ch === "\n") { row.push(cur); rows.push(row); row = []; cur = ""; }
                else cur += ch;
              }
            }
            if (cur.length > 0 || row.length > 0) {
              row.push(cur);
              rows.push(row);
            }
            return rows;
          }




          function parseNumberCell(str) {
            if (str == null) return NaN;
            str = String(str).trim();
            if (!str) return NaN;
            if (str.indexOf("%") !== -1) {
              return parseFloat(str.replace("%", "")) / 100;
            }
            return parseFloat(str);
          }




          /* ---------- VALUATION ELEMENTS & STATE ---------- */


          const valOverlay = document.getElementById("lampad-valuation-overlay");
          const closeValBtn = document.getElementById("close-valuation");


          const psStatusEl = document.getElementById("ps-status");
          const psArtistInput = document.getElementById("ps-artist-input");
          const psArtistDropdown = document.getElementById("ps-artist-dropdown");
          const psDiscountInput = document.getElementById("ps-discount-input");


          const psArtistNameEl = document.getElementById("ps-artist-name");
          const psArtistMetaEl = document.getElementById("ps-artist-meta");
          const psMuSigmaEl = document.getElementById("ps-mu-sigma");
          const psMuSigmaSubEl = document.getElementById("ps-mu-sigma-sub");


          let filteredArtistsForExport = []; // To keep track of filtered set before slicing
          const psNpvCf0El = document.getElementById("ps-npv-cf0");
          const psNpvCf0SubEl = document.getElementById("ps-npv-cf0-sub");
          const psNpvUserEl = document.getElementById("ps-npv-user");
          const psNpvUserSubEl = document.getElementById("ps-npv-user-sub");
          const psImpliedRatesEl = document.getElementById("ps-implied-rates");
          const psImpliedRatesSubEl = document.getElementById("ps-implied-rates-sub");
          const psRiskScoreEl = document.getElementById("ps-risk-score");
          const psRiskExplEl = document.getElementById("ps-risk-expl");
          const psMonthTableBody = document.getElementById("ps-month-table-body");


          const psChartCanvas = document.getElementById("ps-cf-chart");
          let psCfChart = null;


          let psAssumptions = {};
          const ASSUMPTIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQn3QMkLXrOtH76c4ZtlUBfXDYLhIELYr_yehZoZ8OtsRdMGPYU5bIw5f7B358Z99jQIpWIdMI05tdM/pub?gid=1604794205&single=true&output=csv";


          const MONTHS = 120;
          const N_SIMS = 500;




          /* ---------- Formatting helpers ---------- */




          function formatMu(x) {
            if (!isFinite(x)) return "â€“";
            return (x * 100).toFixed(2) + "%";
          }




          function formatPercent(x) {
            if (!isFinite(x)) return "â€“";
            return (x * 100).toFixed(1) + "%";
          }


          /* Helper for Geometric Brownian Motion: Box-Muller transform */
          function gaussianRandom() {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
          }




          function formatMult(x) {
            if (!isFinite(x)) return "â€“";
            return x.toFixed(2);
          }




          function formatNPV(x) {
            if (!isFinite(x)) return "â€“";
            const absX = Math.abs(x);
            if (absX >= 1e12) {
              return (x / 1e12).toFixed(1) + "t";
            } else if (absX >= 1e9) {
              return (x / 1e9).toFixed(1) + "b";
            } else if (absX >= 1e6) {
              return (x / 1e6).toFixed(1) + "m";
            } else if (absX >= 1e3) {
              return (x / 1e3).toFixed(1) + "k";
            } else {
              return x.toFixed(1);
            }
          }




          /* ---------- Rendering ---------- */




          function renderTableRows(rows) {
            const html = rows.map(a => {
              return `
       <tr>
         <td class="li-col-artist">${a.artist || ""}</td>
         <td class="li-col-country">${a.country || ""}</td>
         <td class="li-col-genre">${a.genre || ""}</td>
         <td>${formatMu(a.mu)}</td>
         <td>${formatPercent(a.sigma)}</td>
         <td>${formatPercent(a.muSigma)}</td>
         <td>${formatMult(a.mult)}</td>
         <td>${formatPercent(a.discountRate)}</td>
         <td>${formatNPV(a.npv)}</td>
       </tr>
     `;
            }).join("");
            tableBodyEl.innerHTML = html;


            // Add click listeners to rows
            tableBodyEl.querySelectorAll('tr').forEach((tr, idx) => {
              tr.addEventListener('click', () => {
                openValuation(rows[idx]);
              });
            });
          }




          function renderCardList(rows) {
            const html = rows.map((a, idx) => {
              const metaBits = [];
              if (a.country) metaBits.push(a.country);
              if (a.genre) metaBits.push(a.genre);
              const meta = metaBits.join(" Â· ");




              return `
       <div class="li-card" data-idx="${idx}">
         <div class="li-card-header">
           <div class="li-rank">#${idx + 1}</div>
           <div>
             <div class="li-card-artist">${a.artist || ""}</div>
             <div class="li-card-meta">${meta || ""}</div>
           </div>
         </div>
         <div class="li-card-metrics">
           <div class="li-metric">
             <div class="li-metric-label">Mult</div>
             <div class="li-metric-value">${formatMult(a.mult)}x</div>
           </div>
           <div class="li-metric">
             <div class="li-metric-label">NPV</div>
             <div class="li-metric-value">${formatNPV(a.npv)}</div>
           </div>
           <div class="li-metric">
             <div class="li-metric-label">Mu</div>
             <div class="li-metric-value">${formatMu(a.mu)}</div>
           </div>
           <div class="li-metric">
             <div class="li-metric-label">Sigma</div>
             <div class="li-metric-value">${formatPercent(a.sigma)}</div>
           </div>
           <div class="li-metric">
             <div class="li-metric-label">Mu / Sigma</div>
             <div class="li-metric-value">${formatPercent(a.muSigma)}</div>
           </div>
         </div>
       </div>
     `;
            }).join("");
            cardListEl.innerHTML = html;


            // Add click listeners to cards
            cardListEl.querySelectorAll('.li-card').forEach(card => {
              card.addEventListener('click', () => {
                const idx = parseInt(card.getAttribute('data-idx'));
                openValuation(rows[idx]);
              });
            });
          }




          function renderViews(rows) {
            currentView = rows;
            renderTableRows(rows);
            renderCardList(rows);
          }




          function sortLabel(key) {
            switch (key) {
              case "artist": return "Artist";
              case "country": return "Country";
              case "genre": return "Genre";
              case "mu": return "Mu";
              case "sigma": return "Sigma";
              case "muSigma": return "Mu / Sigma";
              case "mult": return "Mult";
              case "discountRate": return "Discount Rate";
              case "npv": return "NPV";
              default: return key;
            }
          }




          function updateStatusAndPill(filteredCount, totalCount, isFiltered) {
            const activeFilters = [];
            if (artistInput.value.trim()) activeFilters.push("artist");
            if (countryInput.value.trim()) activeFilters.push("country");
            if (genreInput.value.trim()) activeFilters.push("genre");
            if (npvMinInput.value.trim() || npvMaxInput.value.trim()) activeFilters.push("NPV");
            if (multMinInput.value.trim() || multMaxInput.value.trim()) activeFilters.push("Mult");




            const sortText = `Sorted by ${sortLabel(sortState.key)} (${sortState.dir})`;
            const shown = Math.min(MAX_DEFAULT_ROWS, filteredCount || totalCount);




            if (!isFiltered || activeFilters.length === 0) {
              statusEl.innerHTML =
                `Loaded <span>${totalCount}</span> artists. Showing the top <span>${shown}</span> by ${sortLabel(sortState.key)} (${sortState.dir}).`;
              pillTextEl.textContent = `${sortText}, showing top ${MAX_DEFAULT_ROWS}`;
            } else {
              const filterLabel = activeFilters.join(" + ");
              statusEl.innerHTML =
                `Filtered by ${filterLabel}: showing <span>${filteredCount}</span> of <span>${totalCount}</span> artists (max ${MAX_DEFAULT_ROWS} displayed).`;
              pillTextEl.textContent = `${sortText} Â· filtered by ${filterLabel}`;
            }




            sortIndicators.forEach(el => {
              const key = el.getAttribute("data-sort-indicator");
              if (key === sortState.key) {
                el.textContent = sortState.dir === "asc" ? "â–²" : "â–¼";
              } else {
                el.textContent = "";
              }
            });
          }




          /* ---------- Sorting ---------- */




          function sortArray(arr, key, dir) {
            const sorted = arr.slice().sort((a, b) => {
              const va = a[key];
              const vb = b[key];




              if (typeof va === "string" || typeof vb === "string") {
                const sa = (va || "").toString().toLowerCase();
                const sb = (vb || "").toString().toLowerCase();
                if (sa < sb) return -1;
                if (sa > sb) return 1;
                return 0;
              }




              if (va < vb) return -1;
              if (va > vb) return 1;
              return 0;
            });




            if (dir === "desc") sorted.reverse();
            return sorted;
          }




          /* ---------- VALUATION SIMULATION LOGIC ---------- */


          function simulatePaths(cf0Annual, muAnnual, sigmaAnnual) {
            const cf0Month = cf0Annual / 12;
            const dt = 1 / 12; // Monthly time steps (1/12th of a year)

            const cfPaths = new Array(N_SIMS);
            const totals = new Array(N_SIMS);

            for (let s = 0; s < N_SIMS; s++) {
              const path = new Array(MONTHS);
              let cfPrev = cf0Month;
              let total = 0;

              for (let t = 0; t < MONTHS; t++) {
                // Geometric Brownian Motion formula:
                // S_next = S_prev * exp((mu - 0.5 * sigma^2) * dt + sigma * sqrt(dt) * Z)
                const z = gaussianRandom();
                const drift = (muAnnual - 0.5 * Math.pow(sigmaAnnual, 2)) * dt;
                const shock = sigmaAnnual * Math.sqrt(dt) * z;
                const cf = cfPrev * Math.exp(drift + shock);

                path[t] = cf;
                total += cf;
                cfPrev = cf;
              }
              cfPaths[s] = path;
              totals[s] = total;
            }

            // Approximate "Alpha Band" (1-std dev range of monthly growth factors) for UI display
            const driftDisplay = (muAnnual - 0.5 * Math.pow(sigmaAnnual, 2)) * dt;
            const volDisplay = sigmaAnnual * Math.sqrt(dt);
            const alphaLow = Math.exp(driftDisplay - volDisplay);
            const alphaHigh = Math.exp(driftDisplay + volDisplay);

            return { cfPaths, totals, alphaLow, alphaHigh };
          }


          function percentile(sortedArr, p) {
            if (!sortedArr.length) return NaN;
            const n = sortedArr.length;
            const idx = Math.floor(p * (n - 1));
            return sortedArr[idx];
          }


          function npvOfSeries(cfArray, annualRate) {
            let npvVal = 0;
            for (let i = 0; i < cfArray.length; i++) {
              const tYears = (i + 1) / 12;
              npvVal += cfArray[i] / Math.pow(1 + annualRate, tYears);
            }
            return npvVal;
          }


          function impliedDiscountRate(targetNpv, cfArray, rLow, rHigh, iterations) {
            let low = rLow, high = rHigh;
            for (let it = 0; it < iterations; it++) {
              const mid = (low + high) / 2;
              const npvMid = npvOfSeries(cfArray, mid);
              if (npvMid > targetNpv) low = mid; else high = mid;
            }
            return (low + high) / 2;
          }


          function scoreRelative(value, base, low, high, higherIsBetter) {
            if (higherIsBetter) {
              if (value > high) return 2;
              if (value >= base && value <= high) return 1;
              if (value >= low && value < base) return -1;
              return -2;
            } else {
              if (value < low) return 2;
              if (value >= low && value <= base) return 1;
              if (value > base && value <= high) return -1;
              return -2;
            }
          }


          function describeMu(mu, base, low, high) {
            if (mu > high) return "growth (mu) is above the market upper band, indicating stronger than typical market growth.";
            if (mu >= base && mu <= high) return "growth (mu) is above the market average and within the upper band.";
            if (mu >= low && mu < base) return "growth (mu) is within one standard deviation below the market average.";
            return "growth (mu) is below the market lower band, indicating weaker than typical market growth.";
          }


          function describeSigma(sigma, base, low, high) {
            if (sigma < low) return "volatility (sigma) is below the market lower band, suggesting unusually stable cash flows.";
            if (sigma >= low && sigma <= base) return "volatility (sigma) is below the market average and within the lower band.";
            if (sigma > base && sigma <= high) return "volatility (sigma) is above the market average but still within one standard deviation.";
            return "volatility (sigma) is above the market upper band, indicating more risk than typical market assets.";
          }


          function formatCurrency(x) {
            if (!isFinite(x)) return "â€“";
            return "$" + x.toLocaleString(undefined, { maximumFractionDigits: 0 });
          }


          function formatCompactCurrency(x) {
            if (!isFinite(x)) return "â€“";
            const absX = Math.abs(x);
            if (absX >= 1_000_000) {
              return "$" + (x / 1_000_000).toFixed(2) + "m";
            } else if (absX >= 1_000) {
              return "$" + (x / 1_000).toFixed(2) + "k";
            } else {
              return "$" + x.toFixed(2);
            }
          }


          function formatPct(x) {
            if (!isFinite(x)) return "â€“";
            return (x * 100).toFixed(2) + "%";
          }


          function updateMonthTable(p5Array, meanArray, p95Array) {
            const months = Math.min(p5Array.length, meanArray.length, p95Array.length);
            const numYears = Math.floor(months / 12);
            const rows = [];


            for (let y = 0; y < numYears; y++) {
              const start = y * 12;
              const end = start + 12;


              const yearP5 = p5Array.slice(start, end).reduce((a, b) => a + b, 0);
              const yearMean = meanArray.slice(start, end).reduce((a, b) => a + b, 0);
              const yearP95 = p95Array.slice(start, end).reduce((a, b) => a + b, 0);


              rows.push(`
       <tr>
         <td>Year ${y + 1}</td>
         <td>${formatCompactCurrency(yearP5)}</td>
         <td>${formatCompactCurrency(yearMean)}</td>
         <td>${formatCompactCurrency(yearP95)}</td>
       </tr>
     `);
            }


            psMonthTableBody.innerHTML = rows.join("");
          }


          function updateChart(monthP5, monthMean, monthP95) {
            const labels = Array.from({ length: monthP5.length }, (_, i) => i + 1);
            const allValues = [...monthP5, ...monthMean, ...monthP95].filter(v => Number.isFinite(v));


            let yMin = 0, yMax = 1;
            if (allValues.length > 0) {
              const minVal = Math.min(...allValues);
              const maxVal = Math.max(...allValues);
              const span = maxVal - minVal || maxVal || 1;
              const padding = span * 0.3;
              yMin = minVal - padding;
              yMax = maxVal + padding;
            }


            const data = {
              labels,
              datasets: [
                { label: "P5 CF", data: monthP5, borderWidth: 1.5, tension: 0.25, borderColor: "rgba(248,113,113,1)", pointRadius: 0 },
                { label: "Mean CF", data: monthMean, borderWidth: 1.8, tension: 0.25, borderColor: "rgba(56,189,248,1)", pointRadius: 0 },
                { label: "P95 CF", data: monthP95, borderWidth: 1.5, tension: 0.25, borderColor: "rgba(96,165,250,1)", pointRadius: 0 }
              ]
            };


            const options = {
              responsive: true,
              maintainAspectRatio: false,
              layout: {
                padding: { top: 4, right: 8, bottom: 32, left: 8 }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: ctx => ctx.dataset.label + ": " + formatCompactCurrency(ctx.parsed.y)
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: "#9ca3af",
                    maxTicksLimit: 10,
                    padding: 4,
                    font: { size: 9 }
                  },
                  grid: { color: "rgba(31,41,55,0.6)" },
                  title: {
                    display: true,
                    text: "Month",
                    color: "#9ca3af",
                    font: { size: 10 }
                  }
                },
                y: {
                  min: yMin,
                  max: yMax,
                  ticks: {
                    color: "#9ca3af",
                    callback: v => formatCompactCurrency(v)
                  },
                  grid: { color: "rgba(31,41,55,0.6)" }
                }
              }
            };


            if (psCfChart) {
              psCfChart.data = data;
              psCfChart.options = options;
              psCfChart.update();
            } else {
              psCfChart = new Chart(psChartCanvas.getContext("2d"), { type: "line", data, options });
            }
          }


          function runSimulation(artistObj) {
            if (!artistObj) return;


            const discountRate = parseFloat(psDiscountInput.value) / 100 || 0.10;


            const {
              mktMu,
              mktMuLow,
              mktMuHigh,
              mktSigma,
              mktSigmaLow,
              mktSigmaHigh,
              benchmarkSource
            } = psAssumptions;


            const { artist, country, mu, sigma, mult, npv } = artistObj;
            const cf0 = npv / mult;


            psStatusEl.textContent = "Running simulation for " + artist + "â€¦";


            const { cfPaths, alphaLow, alphaHigh } = simulatePaths(cf0, mu, sigma);


            const monthP5 = new Array(MONTHS);
            const monthMean = new Array(MONTHS);
            const monthP95 = new Array(MONTHS);


            for (let t = 0; t < MONTHS; t++) {
              const vals = cfPaths.map(path => path[t]).sort((a, b) => a - b);
              monthP5[t] = percentile(vals, 0.05);
              monthP95[t] = percentile(vals, 0.95);
              monthMean[t] = vals.reduce((a, b) => a + b, 0) / vals.length;
            }


            const npvP5User = npvOfSeries(monthP5, discountRate);
            const npvMeanUser = npvOfSeries(monthMean, discountRate);
            const npvP95User = npvOfSeries(monthP95, discountRate);


            const impliedRateP5 = impliedDiscountRate(npv, monthP5, 0, 0.30, 50);
            const impliedRateMean = impliedDiscountRate(npv, monthMean, 0, 0.30, 50);
            const impliedRateP95 = impliedDiscountRate(npv, monthP95, 0, 0.30, 50);


            let riskScore = NaN;
            let riskExplanation = "Market benchmarks not available; please open Market Stats once to initialize cohorts.";

            const haveLiveBenchmarks = marketBenchmarks && marketBenchmarks.sigmaMean != null;

            if (haveLiveBenchmarks) {
              const { sigmaMean, sigmaStd, sigmaP25, multMedian, muSigmaP90 } = marketBenchmarks;

              // 1. Stability Score (60% weight -> 6 points) - Lower Sigma is Better
              // Base 3 pts for being at mean, +3 for -1.5 SD, -3 for +1.5 SD
              const zSigma = (sigma - sigmaMean) / sigmaStd;
              const stabilityScore = Math.max(0, Math.min(6, 3 - (zSigma * 2)));

              // 2. Valuation Score (40% weight -> 4 points) - Higher Multiple is Better (per user request)
              // Base 2 pts for being at median, +/- 2 based on spread
              const multRatio = mult / multMedian;
              const valuationScore = Math.max(0, Math.min(4, multRatio * 2));

              riskScore = stabilityScore + valuationScore;

              // 3. Heroic Trajectory Flag (Special Badge/Icing)
              const heroicBadge = document.getElementById("ps-heroic-badge");
              if (artistObj.muSigma >= muSigmaP90 && sigma <= sigmaP25) {
                heroicBadge.style.display = "inline-block";
                riskExplanation = "BLUE CHIP POTENTIAL: This asset exhibits a 'Heroic Trajectory' with top-decile momentum and exceptional stability. ";
              } else {
                heroicBadge.style.display = "none";
                riskExplanation = "";
              }

              const qualityLabel = riskScore >= 8 ? "Premium Quality" : (riskScore >= 5 ? "Market Standard" : "Speculative Grade");
              riskExplanation += `Classified as ${qualityLabel} (${riskScore.toFixed(1)}/10). `;

              if (sigma < sigmaMean) {
                riskExplanation += `Stability is ${(Math.abs(zSigma)).toFixed(1)} SD above market average. `;
              } else {
                riskExplanation += `Volatility is ${(zSigma).toFixed(1)} SD above market average. `;
              }

              if (mult > multMedian) {
                riskExplanation += `Trading at a ${((mult / multMedian - 1) * 100).toFixed(0)}% premium to median market multiple.`;
              } else {
                riskExplanation += `Trading at a ${((1 - mult / multMedian) * 100).toFixed(0)}% discount to median market multiple.`;
              }
            }


            psArtistNameEl.textContent = artist;
            psArtistMetaEl.textContent = country || "";


            psMuSigmaEl.textContent = `${formatMu(mu)} / ${formatPercent(sigma)}`;
            psMuSigmaSubEl.textContent = `Alpha band: [${formatPercent(alphaLow - 1)}, ${formatPercent(alphaHigh - 1)}]`;


            psNpvCf0El.textContent = formatCurrency(npv);
            psNpvCf0SubEl.textContent = `CFâ‚€ â‰ˆ ${formatCurrency(cf0)} (NPV / Mult = ${mult.toFixed(2)}x)`;


            psNpvUserEl.textContent = formatCurrency(npvMeanUser);
            psNpvUserSubEl.textContent =
              `P5: ${formatCurrency(npvP5User)} | Mean: ${formatCurrency(npvMeanUser)} | P95: ${formatCurrency(npvP95User)}`;


            const marketRate = artistObj.discountRate || 0;
            psImpliedRatesEl.textContent = `${formatPct(marketRate)} â†’ ${formatPct(impliedRateMean)}`;
            psImpliedRatesSubEl.textContent =
              `Market: ${formatPct(marketRate)} | Implied: ${formatPct(impliedRateMean)} (P5: ${formatPct(impliedRateP5)}, P95: ${formatPct(impliedRateP95)})`;


            psRiskScoreEl.textContent = Number.isFinite(riskScore) ? `${riskScore.toFixed(1)}/10` : "N/A";
            psRiskExplEl.textContent = riskExplanation;


            updateChart(monthP5, monthMean, monthP95);
            updateMonthTable(monthP5, monthMean, monthP95);


            psStatusEl.innerHTML = `Simulation complete for <span>${artist}</span> at discount rate ${formatPct(discountRate)}.`;
          }


          /* ---------- VALUATION UI CONTROLS ---------- */


          function renderPsDropdown(filtered) {
            if (!filtered.length) {
              psArtistDropdown.innerHTML = "";
              psArtistDropdown.classList.remove("ps-open");
              return;
            }


            const items = filtered.slice(0, 20).map(a => {
              const countryLabel = a.country ? `<span class="ps-artist-country">${a.country}</span>` : "";
              return `<div class="ps-dropdown-item" data-artist="${encodeURIComponent(a.artist)}">
               <span class="ps-artist-name">${a.artist}</span>${countryLabel}
             </div>`;
            });


            psArtistDropdown.innerHTML = items.join("");
            psArtistDropdown.classList.add("ps-open");
          }


          function handlePsArtistInput() {
            const query = psArtistInput.value.trim().toLowerCase();
            if (!query) {
              psArtistDropdown.classList.remove("ps-open");
              return;
            }
            const filtered = allArtists.filter(a => a.artist.toLowerCase().includes(query));
            renderPsDropdown(filtered);
          }


          function openValuation(artistObj) {
            if (!artistObj) return;
            valOverlay.classList.add("active");
            document.body.style.overflow = "hidden"; // Prevent background scroll
            psArtistInput.value = artistObj.artist;
            runSimulation(artistObj);
          }


          function closeValuation() {
            valOverlay.classList.remove("active");
            document.body.style.overflow = ""; // Restore background scroll
          }


          closeValBtn.addEventListener("click", closeValuation);


          // Close on backdrop click
          valOverlay.addEventListener("click", (e) => {
            if (e.target === valOverlay) closeValuation();
          });


          psArtistInput.addEventListener("input", handlePsArtistInput);


          psArtistDropdown.addEventListener("click", e => {
            const item = e.target.closest(".ps-dropdown-item");
            if (!item) return;
            const artistName = decodeURIComponent(item.getAttribute("data-artist"));
            const artistObj = allArtists.find(a => a.artist === artistName);
            if (!artistObj) return;
            psArtistInput.value = artistName;
            psArtistDropdown.classList.remove("ps-open");
            runSimulation(artistObj);
          });


          psArtistInput.addEventListener("keydown", e => {
            if (e.key === "Enter") {
              const query = psArtistInput.value.trim().toLowerCase();
              if (!query) return;
              const filtered = allArtists.filter(a => a.artist.toLowerCase().includes(query));
              if (filtered.length === 1) {
                psArtistInput.value = filtered[0].artist;
                psArtistDropdown.classList.remove("ps-open");
                runSimulation(filtered[0]);
              }
            }
          });


          psDiscountInput.addEventListener("change", () => {
            const artistName = psArtistInput.value.trim();
            if (!artistName) return;
            const artistObj = allArtists.find(a => a.artist === artistName);
            if (artistObj) runSimulation(artistObj);
          });




          /* ---------- Filtering ---------- */




          function applyFilters() {
            const artistQ = artistInput.value.trim().toLowerCase();
            const countryQ = countryInput.value.trim().toLowerCase();
            const genreQ = genreInput.value.trim().toLowerCase();




            const npvMinVal = parseFloat(npvMinInput.value);
            const npvMaxVal = parseFloat(npvMaxInput.value);
            const hasNpvMin = !isNaN(npvMinVal);
            const hasNpvMax = !isNaN(npvMaxVal);




            const multMinVal = parseFloat(multMinInput.value);
            const multMaxVal = parseFloat(multMaxInput.value);
            const hasMultMin = !isNaN(multMinVal);
            const hasMultMax = !isNaN(multMaxVal);

            const sigmaMinVal = parseFloat(sigmaMinInput.value) / 100;
            const sigmaMaxVal = parseFloat(sigmaMaxInput.value) / 100;
            const hasSigmaMin = !isNaN(sigmaMinVal);
            const hasSigmaMax = !isNaN(sigmaMaxVal);




            let filtered = allArtists;




            if (artistQ) {
              filtered = filtered.filter(a =>
                (a.artist || "").toLowerCase().includes(artistQ)
              );
            }




            if (countryQ) {
              filtered = filtered.filter(a =>
                (a.country || "").toLowerCase().includes(countryQ)
              );
            }




            if (genreQ) {
              filtered = filtered.filter(a =>
                (a.genre || "").toLowerCase().includes(genreQ)
              );
            }




            if (hasNpvMin) {
              filtered = filtered.filter(a => a.npv >= npvMinVal);
            }




            if (hasNpvMax) {
              filtered = filtered.filter(a => a.npv <= npvMaxVal);
            }




            if (hasMultMin) {
              filtered = filtered.filter(a => a.mult >= multMinVal);
            }




            if (hasMultMax) {
              filtered = filtered.filter(a => a.mult <= multMaxVal);
            }

            if (hasSigmaMin) {
              filtered = filtered.filter(a => a.sigma >= sigmaMinVal);
            }

            if (hasSigmaMax) {
              filtered = filtered.filter(a => a.sigma <= sigmaMaxVal);
            }




            const totalCount = allArtists.length;
            const filteredCount = filtered.length;




            filtered = sortArray(filtered, sortState.key, sortState.dir);


            filteredArtistsForExport = filtered; // Store for CSV export


            const subset = filtered.slice(0, MAX_DEFAULT_ROWS);
            renderViews(subset);




            const isFiltered = !!(
              artistQ ||
              countryQ ||
              genreQ ||
              hasNpvMin ||
              hasNpvMax ||
              hasMultMin ||
              hasMultMax ||
              hasSigmaMin ||
              hasSigmaMax
            );
            updateStatusAndPill(filteredCount, totalCount, isFiltered);
          }




          /* ---------- NPV step behavior (arrow keys) ---------- */




          function handleNpvKeyDown(e) {
            if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;




            e.preventDefault();
            const input = e.target;
            let val = parseFloat(input.value);
            if (isNaN(val)) val = 0;




            const absVal = Math.abs(val);
            const step = absVal < 1_000_000 ? 50_000 : 1_000_000;




            if (e.key === "ArrowUp") {
              val += step;
            } else {
              val -= step;
            }




            input.value = String(val);
            applyFilters();
          }




          /* ---------- Data loading ---------- */




          async function loadIndexData() {
            try {
              statusEl.textContent = "Loading index dataâ€¦";




              const resp = await fetch(CSV_URL);
              const text = await resp.text();
              const rows = parseCsv(text).filter(r => r.length && r.some(c => (c || "").trim() !== ""));




              if (!rows.length) {
                statusEl.textContent = "No index data found.";
                return;
              }




              const header = rows[0];
              const idxArtist = header.indexOf("Artist");
              const idxCountry = header.indexOf("Country");
              const idxGenre = header.indexOf("Genre");
              const idxMu = header.indexOf("Mu");
              const idxSigma = header.indexOf("Sigma");
              const idxMuSigma = header.indexOf("Mu_Sigma");
              const idxMult = header.indexOf("Mult");
              const idxNPV = header.indexOf("NPV");
              const idxDiscountRate = header.indexOf("Discount Rate");




              allArtists = rows.slice(1).map(r => {
                const artist = r[idxArtist] || "";
                const country = r[idxCountry] || "";
                const genre = r[idxGenre] || "";
                const mu = parseNumberCell(r[idxMu]);
                const sigma = parseNumberCell(r[idxSigma]);
                let muSigma = parseNumberCell(r[idxMuSigma]);
                const mult = parseNumberCell(r[idxMult]);
                const npv = parseNumberCell(r[idxNPV]);
                const discountRate = parseNumberCell(r[idxDiscountRate]);




                if (!isFinite(muSigma) && isFinite(mu) && isFinite(sigma) && sigma !== 0) {
                  muSigma = mu / sigma;
                }




                return { artist, country, genre, mu, sigma, muSigma, mult, npv, discountRate };
              }).filter(a =>
                a.artist &&
                Number.isFinite(a.mu) &&
                Number.isFinite(a.sigma) &&
                Number.isFinite(a.mult) &&
                Number.isFinite(a.npv)
              );




              sortState = { key: "mult", dir: "desc" };
              applyFilters();


              // After index data is loaded, fetch valuation assumptions
              await loadValuationAssumptions();

              // Initialize market benchmarks for scoring
              runMarketStats();
            } catch (err) {
              console.error(err);
              statusEl.textContent = "Error loading index data. Please refresh or check console.";
            }
          }


          async function loadValuationAssumptions() {
            try {
              psStatusEl.textContent = "Loading model dataâ€¦";
              const resp = await fetch(ASSUMPTIONS_CSV_URL);
              const text = await resp.text();
              const aRows = parseCsv(text).filter(
                r => r.length && r.some(c => (c || "").trim() !== "")
              );


              let riskFreeRate = NaN,
                mktMu = NaN, mktMuLow = NaN, mktMuHigh = NaN,
                mktSigma = NaN, mktSigmaLow = NaN, mktSigmaHigh = NaN;


              for (const row of aRows) {
                const dim = (row[0] || "").trim();
                if (dim === "Risk Free Rate") riskFreeRate = parseNumberCell(row[1]);
                if (dim === "WeeklyMu_3Y") {
                  mktMu = parseNumberCell(row[1]);
                  mktMuLow = parseNumberCell(row[2]);
                  mktMuHigh = parseNumberCell(row[3]);
                }
                if (dim === "WeeklySigma_3Y") {
                  mktSigma = parseNumberCell(row[1]);
                  mktSigmaLow = parseNumberCell(row[2]);
                  mktSigmaHigh = parseNumberCell(row[3]);
                }
              }


              const benchmarksValid = [mktMu, mktMuLow, mktMuHigh, mktSigma, mktSigmaLow, mktSigmaHigh].every(v => Number.isFinite(v));
              let benchmarkSource = "csv";


              if (!benchmarksValid) {
                benchmarkSource = "fallback";
                if (!Number.isFinite(mktMu)) mktMu = -0.0012;
                if (!Number.isFinite(mktMuLow)) mktMuLow = -0.0056;
                if (!Number.isFinite(mktMuHigh)) mktMuHigh = 0.0031;
                if (!Number.isFinite(mktSigma)) mktSigma = 0.061;
                if (!Number.isFinite(mktSigmaLow)) mktSigmaLow = 0.03;
                if (!Number.isFinite(mktSigmaHigh)) mktSigmaHigh = 0.093;
              }


              psAssumptions = { riskFreeRate, mktMu, mktMuLow, mktMuHigh, mktSigma, mktSigmaLow, mktSigmaHigh, benchmarkSource };
              psStatusEl.textContent = "Model data loaded.";
            } catch (err) {
              console.error(err);
              psStatusEl.textContent = "Error loading model data.";
            }
          }




          /* ---------- CSV EXPORT LOGIC ---------- */


          function exportToCSV() {
            if (!filteredArtistsForExport.length) {
              alert("No data to export.");
              return;
            }


            const headers = ["Artist", "Country", "Genre", "Mu", "Sigma", "Mu/Sigma", "Mult", "NPV"];
            const rows = filteredArtistsForExport.map(a => [
              `"${(a.artist || "").replace(/"/g, '""')}"`,
              `"${(a.country || "").replace(/"/g, '""')}"`,
              `"${(a.genre || "").replace(/"/g, '""')}"`,
              a.mu,
              a.sigma,
              a.muSigma,
              a.mult,
              a.npv
            ]);


            const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");


            const dateStr = new Date().toISOString().split('T')[0];
            link.setAttribute("href", url);
            link.setAttribute("download", `lampad_index_export_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }




          /* ---------- Event wiring ---------- */




          artistInput.addEventListener("input", applyFilters);
          countryInput.addEventListener("input", applyFilters);
          genreInput.addEventListener("input", applyFilters);
          npvMinInput.addEventListener("input", applyFilters);
          npvMaxInput.addEventListener("input", applyFilters);
          multMinInput.addEventListener("input", applyFilters);
          multMaxInput.addEventListener("input", applyFilters);
          sigmaMinInput.addEventListener("input", applyFilters);
          sigmaMaxInput.addEventListener("input", applyFilters);




          npvMinInput.addEventListener("keydown", handleNpvKeyDown);
          npvMaxInput.addEventListener("keydown", handleNpvKeyDown);




          headerCells.forEach(th => {
            th.addEventListener("click", () => {
              const key = th.getAttribute("data-sort-key");
              if (!key) return;




              if (sortState.key === key) {
                sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
              } else {
                sortState.key = key;
                if (["mu", "sigma", "muSigma", "mult", "npv"].includes(key)) {
                  sortState.dir = "desc";
                } else {
                  sortState.dir = "asc";
                }
              }




              applyFilters();
            });
          });




          /* ---------- Boot ---------- */




          loadIndexData();


          /* ---------- KEYBOARD SHORTCUTS ---------- */


          window.addEventListener("keydown", (e) => {
            if (valOverlay.classList.contains("active")) {
              if (e.key === "Escape" || e.key === "Delete" || e.key === "Backspace") {
                // Only close on Backspace/Delete if not typing in an input
                if ((e.key === "Delete" || e.key === "Backspace") && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) {
                  return;
                }
                closeValuation();
              }
            }
          });


          document.getElementById("li-export-csv").addEventListener("click", exportToCSV);

          /* ---------- MARKET STATS LOGIC & CALCS ---------- */
          let marketSigmaChart = null;
          let marketScatterChart = null;
          let marketDiscountChart = null;
          let marketDiscountScatterChart = null;

          function runMarketStats() {
            if (!allArtists.length) return;

            // 1. Data Preparation
            const sigmas = allArtists.map(a => a.sigma).filter(v => isFinite(v)).sort((a, b) => a - b);
            if (!sigmas.length) return;

            // 2. Winsorizing (cap at 97.5%) - Median is calculated on raw for robustness
            const median = percentile(sigmas, 0.5);
            const p975 = percentile(sigmas, 0.975);
            const winsorized = sigmas.map(v => Math.min(v, p975));

            // 3. Winsorized Stats (Mean & StdDev based on the capped cohort)
            const sum = winsorized.reduce((a, b) => a + b, 0);
            const mean = sum / winsorized.length;
            const sqDiffs = winsorized.map(v => Math.pow(v - mean, 2));
            const stdDev = Math.sqrt(sqDiffs.reduce((a, b) => a + b, 0) / winsorized.length);

            // 4. Multiple Stats
            const mults = allArtists.map(a => a.mult).filter(v => isFinite(v)).sort((a, b) => a - b);
            const medianMult = mults.length ? percentile(mults, 0.5) : 0;
            const p975Mult = mults.length ? percentile(mults, 0.975) : 0;

            // 5. UI Updates
            document.getElementById("stats-mean-sigma").textContent = formatPercent(mean);
            document.getElementById("stats-median-sigma").textContent = formatPercent(median);
            document.getElementById("stats-std-sigma").textContent = formatPercent(stdDev);
            document.getElementById("stats-median-mult").textContent = formatMult(medianMult);

            // 5b. Mu/Sigma Stats
            const muSigmas = allArtists.map(a => a.muSigma).filter(v => isFinite(v)).sort((a, b) => a - b);
            const meanMuSigma = muSigmas.reduce((a, b) => a + b, 0) / muSigmas.length;
            const p90MuSigma = percentile(muSigmas, 0.90);

            // Heroic Threshold: Top 10% Mu/Sigma AND Bottom 25% Sigma
            const p25Sigma = percentile(sigmas, 0.25);
            const heroicArtists = allArtists.filter(a => a.muSigma >= p90MuSigma && a.sigma <= p25Sigma);

            document.getElementById("stats-mean-musigma").textContent = meanMuSigma.toFixed(2);
            document.getElementById("stats-heroic-count").textContent = heroicArtists.length;

            // 5c. Store Benchmarks for Valuation Scoring
            marketBenchmarks = {
              sigmaMean: mean,
              sigmaStd: stdDev,
              sigmaP25: p25Sigma,
              multMedian: medianMult,
              muSigmaP90: p90MuSigma
            };

            // 6. Histogram Generation
            const numBins = 30;
            const min = winsorized[0];
            const max = winsorized[winsorized.length - 1];
            const binWidth = (max - min) / numBins;

            const bins = new Array(numBins).fill(0);
            const labels = new Array(numBins);

            for (let i = 0; i < numBins; i++) {
              const start = min + i * binWidth;
              const end = start + binWidth;
              labels[i] = formatPercent(start);

              winsorized.forEach(v => {
                if (v >= start && (i === numBins - 1 ? v <= end : v < end)) {
                  bins[i]++;
                }
              });
            }

            // 7. Interpretation
            const within1 = winsorized.filter(v => v >= mean - stdDev && v <= mean + stdDev).length;
            const within2 = winsorized.filter(v => v >= mean - 2 * stdDev && v <= mean + 2 * stdDev).length;
            const pct1 = ((within1 / winsorized.length) * 100).toFixed(1);
            const pct2 = ((within2 / winsorized.length) * 100).toFixed(1);

            document.getElementById("stats-interpretation-text").innerHTML = `
              The market distribution shows a <strong>Winsorized Mean Sigma of ${formatPercent(mean)}</strong>. 
              In this cohort, <strong>${pct1}%</strong> of artists fall within 1 standard deviation of the mean.
              <br><br>
              <strong>Heroic Trajectory Analysis:</strong> We've identified <strong>${heroicArtists.length} artists</strong> 
              (${((heroicArtists.length / allArtists.length) * 100).toFixed(1)}% of market) exhibiting "Blue Chip" characteristics: 
              Reward-to-Risk (Mu/Sigma) in the top 10th percentile (>${p90MuSigma.toFixed(2)}) 
              combined with volatility in the bottom quartile (<${formatPercent(p25Sigma)}).
            `;

            // 8. Sigma Histogram Chart
            if (marketSigmaChart) {
              marketSigmaChart.destroy();
            }

            const ctx = document.getElementById("market-sigma-chart").getContext("2d");
            marketSigmaChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Frequency',
                  data: bins,
                  backgroundColor: 'rgba(56, 189, 248, 0.4)',
                  borderColor: 'rgba(56, 189, 248, 1)',
                  borderWidth: 1,
                  barPercentage: 1,
                  categoryPercentage: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      title: (items) => `Sigma Range: ${items[0].label}+`,
                      label: (item) => `Total Artists: ${item.raw}`
                    }
                  }
                },
                scales: {
                  x: {
                    title: { display: true, text: 'Annualized Sigma (Volatility)', color: '#9ca3af', font: { size: 10 } },
                    ticks: { color: '#6b7280', font: { size: 9 }, maxRotation: 45, minRotation: 45 },
                    grid: { color: 'rgba(31, 41, 55, 0.5)' }
                  },
                  y: {
                    title: { display: true, text: 'Count', color: '#9ca3af', font: { size: 10 } },
                    ticks: { color: '#6b7280', font: { size: 9 } },
                    grid: { color: 'rgba(31, 41, 55, 0.5)' }
                  }
                }
              }
            });

            // 9. TAM Calculations
            const validNPVs = allArtists.filter(a => isFinite(a.npv) && isFinite(a.mult));

            // Total Market Cap = Sum of all NPVs
            const totalMarketCap = validNPVs.reduce((sum, a) => sum + a.npv, 0);

            // Implied Annual Revenue = Sum of (NPV / Multiple)
            const totalAnnualRev = validNPVs.reduce((sum, a) => sum + (a.npv / a.mult), 0);

            // Weighted Average Multiple = Market Cap / Annual Revenue
            const weightedAvgMult = totalAnnualRev > 0 ? totalMarketCap / totalAnnualRev : 0;

            // Market Concentration: Top 10% of artists by NPV
            const sortedByNPV = [...validNPVs].sort((a, b) => b.npv - a.npv);
            const top10Count = Math.ceil(sortedByNPV.length * 0.1);
            const top10NPV = sortedByNPV.slice(0, top10Count).reduce((sum, a) => sum + a.npv, 0);
            const concentration = totalMarketCap > 0 ? (top10NPV / totalMarketCap) * 100 : 0;

            // Update TAM UI
            document.getElementById("tam-market-cap").textContent = formatNPV(totalMarketCap);
            document.getElementById("tam-annual-rev").textContent = formatNPV(totalAnnualRev);
            document.getElementById("tam-avg-mult").textContent = formatMult(weightedAvgMult);
            document.getElementById("tam-concentration").textContent = concentration.toFixed(1) + "%";

            // 10. Scatter Plot (Multiple vs Sigma)
            const scatterData = allArtists
              .filter(a => isFinite(a.sigma) && isFinite(a.mult))
              .map(a => ({
                x: a.sigma,
                y: a.mult,
                artist: a.artist
              }));

            if (marketScatterChart) {
              marketScatterChart.destroy();
            }

            const ctxScatter = document.getElementById("market-scatter-chart").getContext("2d");
            marketScatterChart = new Chart(ctxScatter, {
              type: 'scatter',
              data: {
                datasets: [{
                  label: 'Artists',
                  data: scatterData,
                  backgroundColor: 'rgba(56, 189, 248, 0.5)',
                  borderColor: 'rgba(56, 189, 248, 0.8)',
                  borderWidth: 1,
                  pointRadius: 3,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'nearest',
                  intersect: true,
                  axis: 'xy'
                },
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      title: (items) => items[0].raw.artist || 'Artist',
                      label: (item) => `Multiple: ${formatMult(item.raw.y)} | Sigma: ${formatPercent(item.raw.x)}`
                    }
                  }
                },
                scales: {
                  x: {
                    title: { display: true, text: 'Sigma (Risk)', color: '#9ca3af', font: { size: 10 } },
                    ticks: { color: '#6b7280', font: { size: 9 } },
                    grid: { color: 'rgba(31, 41, 55, 0.5)' }
                  },
                  y: {
                    title: { display: true, text: 'Multiple (Price)', color: '#9ca3af', font: { size: 10 } },
                    ticks: { color: '#6b7280', font: { size: 9 } },
                    grid: { color: 'rgba(31, 41, 55, 0.5)' }
                  }
                }
              }
            });

            // 11. Discount Rate Analysis
            const discountRates = allArtists
              .map(a => a.discountRate)
              .filter(v => isFinite(v))
              .sort((a, b) => a - b);

            if (discountRates.length > 0) {
              // Winsorize discount rates at 97.5th percentile to handle fat tails
              const medianDiscount = percentile(discountRates, 0.5);
              const p975Discount = percentile(discountRates, 0.975);
              const winsorizedDiscounts = discountRates.map(v => Math.min(v, p975Discount));

              // Calculate winsorized statistics
              const discountSum = winsorizedDiscounts.reduce((a, b) => a + b, 0);
              const meanDiscount = discountSum / winsorizedDiscounts.length;

              // Update UI
              document.getElementById("stats-mean-discount").textContent = formatPercent(meanDiscount);
              document.getElementById("stats-median-discount").textContent = formatPercent(medianDiscount);

              // 12. Discount Rate Distribution Histogram (using winsorized data)
              const numDiscountBins = 25;
              const minDiscount = winsorizedDiscounts[0];
              const maxDiscount = winsorizedDiscounts[winsorizedDiscounts.length - 1];
              const discountBinWidth = (maxDiscount - minDiscount) / numDiscountBins;

              const discountBins = new Array(numDiscountBins).fill(0);
              const discountLabels = new Array(numDiscountBins);

              for (let i = 0; i < numDiscountBins; i++) {
                const start = minDiscount + i * discountBinWidth;
                const end = start + discountBinWidth;
                discountLabels[i] = formatPercent(start);

                winsorizedDiscounts.forEach(v => {
                  if (v >= start && (i === numDiscountBins - 1 ? v <= end : v < end)) {
                    discountBins[i]++;
                  }
                });
              }

              if (marketDiscountChart) {
                marketDiscountChart.destroy();
              }

              const ctxDiscount = document.getElementById("market-discount-chart").getContext("2d");
              marketDiscountChart = new Chart(ctxDiscount, {
                type: 'bar',
                data: {
                  labels: discountLabels,
                  datasets: [{
                    label: 'Frequency',
                    data: discountBins,
                    backgroundColor: 'rgba(167, 139, 250, 0.4)',
                    borderColor: 'rgba(167, 139, 250, 1)',
                    borderWidth: 1,
                    barPercentage: 1,
                    categoryPercentage: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false },
                    tooltip: {
                      callbacks: {
                        title: (items) => `Discount Rate: ${items[0].label}+`,
                        label: (item) => `Total Artists: ${item.raw}`
                      }
                    }
                  },
                  scales: {
                    x: {
                      title: { display: true, text: 'Discount Rate (Required Return)', color: '#9ca3af', font: { size: 10 } },
                      ticks: { color: '#6b7280', font: { size: 9 }, maxRotation: 45, minRotation: 45 },
                      grid: { color: 'rgba(31, 41, 55, 0.5)' }
                    },
                    y: {
                      title: { display: true, text: 'Count', color: '#9ca3af', font: { size: 10 } },
                      ticks: { color: '#6b7280', font: { size: 9 } },
                      grid: { color: 'rgba(31, 41, 55, 0.5)' }
                    }
                  }
                }
              });

              // 13. Discount Rate vs Sigma Scatter Plot (using winsorized discount rates)
              const discountScatterData = allArtists
                .filter(a => isFinite(a.sigma) && isFinite(a.discountRate))
                .map(a => ({
                  x: a.sigma,
                  y: Math.min(a.discountRate, p975Discount), // Cap at 97.5th percentile
                  artist: a.artist
                }));

              if (marketDiscountScatterChart) {
                marketDiscountScatterChart.destroy();
              }

              const ctxDiscountScatter = document.getElementById("market-discount-scatter-chart").getContext("2d");
              marketDiscountScatterChart = new Chart(ctxDiscountScatter, {
                type: 'scatter',
                data: {
                  datasets: [{
                    label: 'Artists',
                    data: discountScatterData,
                    backgroundColor: 'rgba(167, 139, 250, 0.5)',
                    borderColor: 'rgba(167, 139, 250, 0.8)',
                    borderWidth: 1,
                    pointRadius: 3,
                    pointHoverRadius: 5
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'nearest',
                    intersect: true,
                    axis: 'xy'
                  },
                  plugins: {
                    legend: { display: false },
                    tooltip: {
                      callbacks: {
                        title: (items) => items[0].raw.artist || 'Artist',
                        label: (item) => `Discount Rate: ${formatPercent(item.raw.y)} | Sigma: ${formatPercent(item.raw.x)}`
                      }
                    }
                  },
                  scales: {
                    x: {
                      title: { display: true, text: 'Sigma (Risk/Volatility)', color: '#9ca3af', font: { size: 10 } },
                      ticks: { color: '#6b7280', font: { size: 9 } },
                      grid: { color: 'rgba(31, 41, 55, 0.5)' }
                    },
                    y: {
                      title: { display: true, text: 'Discount Rate (Required Return)', color: '#9ca3af', font: { size: 10 } },
                      ticks: {
                        color: '#6b7280',
                        font: { size: 9 },
                        callback: function (value) {
                          return (value * 100).toFixed(1) + '%';
                        }
                      },
                      grid: { color: 'rgba(31, 41, 55, 0.5)' }
                    }
                  }
                }
              });
            }
          }

          openStatsBtn.addEventListener("click", () => {
            statsOverlay.classList.add("active");
            document.body.style.overflow = "hidden";
            runMarketStats();
          });


          const closeStats = () => {
            statsOverlay.classList.remove("active");
            document.body.style.overflow = "";
          };


          closeStatsBtn.addEventListener("click", closeStats);
          statsOverlay.addEventListener("click", (e) => {
            if (e.target === statsOverlay) closeStats();
          });


          window.addEventListener("keydown", (e) => {
            if (statsOverlay.classList.contains("active") && e.key === "Escape") {
              closeStats();
            }
          });
        } // End initializeApp function

        // If already authenticated on page load, initialize the app
        if (isAuthenticated) {
          initializeApp();
        }
      })();
    </script>
</body>

</html>